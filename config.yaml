# Patient Aggregation Configuration

# Patient identifier column name (used to group records)
patient_id_column: "patient_uid"

# Input files configuration
# Supported formats: .xlsx, .xls, .csv
# The system will automatically detect the file format
files:
  - name: "iop"
    file: "iop.xlsx"  # Can also be "iop.csv"
    columns:
      - name: "od_iop"
        type: "int"
        aggregation: "list"
      - name: "os_iop"
        type: "int"
        aggregation: "list"
  
  - name: "diagnosis"
    file: "diagnosis.xlsx"
    columns:
      - name: "source_severity"
        type: "str"
        aggregation: "list"
      - name: "code"
        type: "str"
        aggregation: "list"
      - name: "short_desc"
        type: "str"
        aggregation: "list"
  
  - name: "enc"
    file: "enc.xlsx"
    columns:
      - name: "bp_systolic"
        type: "int"
        aggregation: "list"
      - name: "bp_diastolic"
        type: "int"
        aggregation: "list"
      - name: "pulse"
        type: "int"
        aggregation: "list"

# Output configuration
output:
  format: "json_array"  # Options: json_array, comma_separated, pipe_separated
  directory: "output"  # Directory where all output files will be saved
  aggregated_file: "aggregated_patients.csv"  # Main aggregated output file
  generate_full_plots: false  # Set to true to generate full aggregated plots (numeric_distributions, categorical_counts, etc.)

# Filtering and subsetting configuration
filtering:
  enabled: true  # Set to false to disable filtering
  subset_file: "aggregated_patients_subset.csv"  # Subset file name (saved in output directory)
  
  # Required columns: each patient must have at least min_count values
  required_columns:
    bp_systolic:
      min_count: 1  # At least 1 SBP measurement
      description: "Systolic blood pressure"
    bp_diastolic:
      min_count: 1  # At least 1 DBP measurement
      description: "Diastolic blood pressure"
    pulse:
      min_count: 1  # At least 1 HR measurement
      description: "Heart rate / pulse"
  
  # Group requirements: patient must have at least min_count values across the group
  group_requirements:
    - name: "iop_measurements"
      columns: ["od_iop", "os_iop"]  # At least one IOP value (either eye)
      min_count: 1
      description: "At least one IOP measurement from either eye"

# Feature engineering configuration
features:
  enabled: true
  compute_means: true
  compute_derived: true
  compute_variability: true
  
  # Columns to compute means for
  mean_columns:
    - pulse
    - od_iop
    - os_iop
    - bp_systolic
    - bp_diastolic
  
  # Data cleaning configuration
  data_cleaning:
    enabled: true  # Enable/disable data cleaning
    method: "both"  # Options: "threshold", "iqr", or "both"
    action: "warn"  # Options: "warn" (log warnings), "remove" (filter out), or "cap" (clip to limits)
    iqr_multiplier: 3.0  # For IQR-based outlier detection (1.5 for mild, 3.0 for strict)
    
    # Physiologically reasonable thresholds for each feature
    thresholds:
      pulse:
        min: 30
        max: 200
        description: "Heart rate (bpm)"
      od_iop:
        min: 0
        max: 100
        description: "Intraocular pressure OD (mmHg)"
      os_iop:
        min: 0
        max: 100
        description: "Intraocular pressure OS (mmHg)"
      bp_systolic:
        min: 40
        max: 250
        description: "Systolic blood pressure (mmHg)"
      bp_diastolic:
        min: 20
        max: 150
        description: "Diastolic blood pressure (mmHg)"
      pulse_mean:
        min: 30
        max: 200
        description: "Mean heart rate (bpm)"
      od_iop_mean:
        min: 0
        max: 100
        description: "Mean IOP OD (mmHg)"
      os_iop_mean:
        min: 0
        max: 100
        description: "Mean IOP OS (mmHg)"
      bp_systolic_mean:
        min: 40
        max: 250
        description: "Mean SBP (mmHg)"
      bp_diastolic_mean:
        min: 20
        max: 150
        description: "Mean DBP (mmHg)"
      map:
        min: 30
        max: 200
        description: "Mean arterial pressure (mmHg)"
      mopp_od:
        min: -50
        max: 200
        description: "Mean ocular perfusion pressure OD (mmHg)"
      mopp_os:
        min: -50
        max: 200
        description: "Mean ocular perfusion pressure OS (mmHg)"
      sopp_od:
        min: -50
        max: 200
        description: "Systolic ocular perfusion pressure OD (mmHg)"
      sopp_os:
        min: -50
        max: 200
        description: "Systolic ocular perfusion pressure OS (mmHg)"
      dopp_od:
        min: -50
        max: 200
        description: "Diastolic ocular perfusion pressure OD (mmHg)"
      dopp_os:
        min: -50
        max: 200
        description: "Diastolic ocular perfusion pressure OS (mmHg)"
  
  # Derived features configuration
  derived_features:
    map:
      formula: "bp_diastolic_mean + (1/3) * (bp_systolic_mean - bp_diastolic_mean)"
      description: "Mean Arterial Pressure"
    mopp_od:
      formula: "(2/3) * map - od_iop_mean"
      description: "Mean Ocular Perfusion Pressure OD"
    mopp_os:
      formula: "(2/3) * map - os_iop_mean"
      description: "Mean Ocular Perfusion Pressure OS"
    sopp_od:
      formula: "bp_systolic_mean - od_iop_mean"
      description: "Systolic Ocular Perfusion Pressure OD"
    sopp_os:
      formula: "bp_systolic_mean - os_iop_mean"
      description: "Systolic Ocular Perfusion Pressure OS"
    dopp_od:
      formula: "bp_diastolic_mean - od_iop_mean"
      description: "Diastolic Ocular Perfusion Pressure OD"
    dopp_os:
      formula: "bp_diastolic_mean - os_iop_mean"
      description: "Diastolic Ocular Perfusion Pressure OS"

# Stratified EDA configuration
stratified_eda:
  enabled: true
  stratification_column: "source_severity"  # Column to group by
  output_subdirectory: "stratified_plots"  # Subdirectory in plots/
  
  # Group ordering configuration
  group_order:
    - mild
    - moderate
    - severe
    - unspecified
    - indeterminate
  # Groups will be displayed in this order in all plots
  
  # Features to plot by group
  features_to_plot:
    - pulse_mean
    - od_iop_mean
    - os_iop_mean
    - bp_systolic_mean
    - bp_diastolic_mean
    - map
    - mopp_od
    - mopp_os
    - sopp_od
    - sopp_os
    - dopp_od
    - dopp_os
  
  # Variability features to plot
  variability_features:
    - pulse_std
    - od_iop_std
    - os_iop_std
    - bp_systolic_std
    - bp_diastolic_std
  
  # Statistical testing configuration
  statistical_tests:
    enabled: true
    tests:
      - name: "t-test"
        description: "Student's t-test (parametric, 2 groups)"
        use_for: ["2_groups"]
      - name: "mannwhitney"
        description: "Mann-Whitney U test (non-parametric, 2 groups)"
        use_for: ["2_groups", "non_parametric"]
      - name: "anova"
        description: "One-way ANOVA (parametric, 3+ groups)"
        use_for: ["3plus_groups"]
      - name: "kruskal"
        description: "Kruskal-Wallis test (non-parametric, 3+ groups)"
        use_for: ["3plus_groups", "non_parametric"]
    
    # Auto-select test based on group count and data distribution
    auto_select: true
    
    # Large sample handling configuration
    large_sample_threshold: 5000  # Threshold for warning about p-value accuracy
    method: "auto"  # Options: "auto", "exact", "asymptotic"
    max_exact_sample_size: 5000  # Maximum sample size to use exact method
    sample_down_for_exact: false  # If true, sample down to max_exact_sample_size when using exact
    suppress_warnings: false  # Suppress scipy warnings about large samples
    
    # Groups to exclude from statistical analysis
    excluded_groups:
      - indeterminate
      - intermediate
      - unspecified
    
    # Significance levels for asterisks
    significance_levels:
      "*": 0.05
      "**": 0.01
      "***": 0.001
    
    # Display options
    display:
      show_asterisks: true
      show_numeric: true
      show_brackets: true  # Show brackets connecting groups being compared
  
  # Features to include in statistical tests (all engineered features + means + variability)
  features_for_statistics:
    - pulse_mean
    - od_iop_mean
    - os_iop_mean
    - bp_systolic_mean
    - bp_diastolic_mean
    - pulse_std
    - od_iop_std
    - os_iop_std
    - bp_systolic_std
    - bp_diastolic_std
    - map
    - mopp_od
    - mopp_os
    - sopp_od
    - sopp_os
    - dopp_od
    - dopp_os
  
  # Summary table generation
  generate_summary_tables: true  # Enable/disable summary table generation
  summary_table_format: "both"  # Options: "csv", "txt", "both"

